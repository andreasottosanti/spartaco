---
title: "Simultaneous clustering of genes and spots in 10X Visium spatial experiments using SpaRTaCo"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{real data analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

In this vignette, we show the use of the SpaRTaCo model (*Sottosanti and Risso, 2021+*), to analyze 10X Visium spatial experiments. The following analysis is highly computationally expensive and for this reason it has been run locally and further uploaded.

## spatialLIBD data: subject 151673

We display the same analysis proposed by *Sottosanti and Risso (2021+)* using a human dorsolateral prefrontal cortex tissue sample collected by *Maynard et al. (2021)*.

```{r, echo = F}
library(spartaco)
library(ggplot2)
library(scry)
#load("results.Rdata")
load("DeviancePlot.Rdata")
```


### Data import and pre-processing

```{r, eval=F}
library(spartaco)
library(spatialLIBD)
library(scry)
library(ggplot2)

ehub <- ExperimentHub::ExperimentHub()
```

The package `spatialLIBD` allows to load the data either as `SingleCellExperiment` and `SpatialExperiment` objects. For instance, the two following lines load the same content, but creating two objects of different classes.

```{r, eval=F}
if (!exists("sce")) sce <- fetch_data(type = "sce", eh = ehub) # SingleCellExperiment
if (!exists("spe")) spe <- fetch_data(type = "spe", eh = ehub) # SpatialExperiment
```

We will use the `SpatialExperiment` object; however, the same analysis can be done using the the object `sce`. We select the sample of interest:

```{r, eval = F}
spe <- spe[,colData(spe)$sample_id == "151673"]
```

```{r, echo = F, fig.width = 6.5, fig.height=5, fig.align="center"}
knitr::include_graphics("151673.pdf")
```

As first, we reduce the number of genes by selecting only those whose number of counts is at least 300.

```{r, eval=F}
spe <- spe[which(rowSums(counts(spe)) >= 300),]
```

We now select the genes informative on the occurring biological processes in the sample using the method of *Townes et al. (2019)*. The functions are implemented into the package `scry`. First, we compute the deviance of each gene using the binomal approximation of the multinomial likelihood.

```{r, eval = F}
spe <- devianceFeatureSelection(spe, assay="counts", sorted=TRUE)
DeviancePlot <- data.frame(x = 1:nrow(spe),
                           y = rowData(spe)$binomial_deviance)
ggplot(DeviancePlot, aes(x, y))+geom_line()+
  labs(x = "ranked genes", y = "deviance", color = "")+theme_classic()+
  geom_vline(aes(xintercept = 200, color = "Ideal cut-off"), lty = 2)+
  geom_vline(aes(xintercept = 500, color = "Actual cut-off"), lty = 2)+
  scale_color_manual( values = c('Ideal cut-off' = 4, 'Actual cut-off' = 2))+
  theme(legend.position = "bottom")
```

```{r, echo = F, fig.width = 6, fig.height=4, fig.align="center" }
ggplot(DeviancePlot, aes(x, y))+geom_line()+
  labs(x = "ranked genes", y = "deviance", color = "")+theme_classic()+
  geom_vline(aes(xintercept = 200, color = "Ideal cut-off"), lty = 2)+
  geom_vline(aes(xintercept = 500, color = "Actual cut-off"), lty = 2)+
  scale_color_manual( values = c('Ideal cut-off' = 4, 'Actual cut-off' = 2))+
  theme(legend.position = "bottom")
```

Last, the transformed data correspond to the deviance residuals.

```{r, eval=F}
spe <- nullResiduals(spe, assay="counts", fam = "binomial", type = "deviance")
spe <- spe[1:500,]
```

This quantity is now available as an assay of the `spe` object.

### SpaRTaCo model fitting

We run SpaRTaCo for 3,000 iterations, starting from five different sets of initial points. Since `spe` is an object of class `SpatialExperiment`, it can be used directly into the function for estimating the model.

```{r, eval = F}
results <- spartaco_multirun(spe, assay = "binomial_deviance_residuals", K = 2, R = 9, nstart = 5, max.iter = 3000, mc.cores = 5)
```

To run SpaRTaCo with multiple dimensions, one could use the function `parallel::mclapply`. Let us suppose for example that we evaluate the range of column clusters from 7 to 12. Note that, in order to perform each single estimation in parallel, we need 30 cores.

```{r, eval = F}
R.values <- 7:12
multiresults <- parallel::mclapply(R.values, function(r)
  spartaco_multirun(data = spe, assay = "binomial_deviance_residuals", K = 2, R = r, nstart = 5, max.iter = 3000, mc.cores = 5), mc.cores = length(R.values))
ICL.values <- unlist(lapply(multiresults, function(x) x$ICL));ICL.values
```

From the ICL it is visible that the best model is the one with `R = 12`; however, we believe that the local maximum in correspondence of
`R = 9` represents also a valid solution. In fact, a large value of `R` would result in too many small clusters, complicating the biological interpretation.

```{r, eval = F}
sel.model <- multiresults[[which.max(ICL.values)]]
```

`sel.model` is an object of class `spartaco`. The clustering labels are contained into the objects `sel.model$Cs` and `sel.model$Ds`. To display the mean levels and the spatial signal-to-noise ratios within the blocks, run


```{r, eval = F, fig.width = 6.5, fig.height=4, fig.align="center"}
plot(sel.model, type = 1)
plot(sel.model, type = 2)
```

To display the spot clusters, run

```{r, eval = F, fig.width = 6.5, fig.height=5, fig.align="center"}
plot(sel.model, type = 3)
```

It appears that the spatial activity of the genes in $\mathcal{C}_2$ is largely evident within
the internal area of the White Matter ($\mathcal{D}_1$, signal-to-noise ratio = ` round(sel.model$stn.ratio[2,1],2)`) and progressively decreases approaching Layer
6 (signal-to-noise ratio of $\mathcal{D}_8$ = ` round(sel.model$stn.ratio[2,8],2)`, and signal-to-noise ratio of $\mathcal{D}_9$ = ` round(sel.model$stn.ratio[2,9],2)`).

To display the average gene expression of the genes in $k = 2$ and within the regions $r \in \{1,8,9 \}$, run

```{r, eval = F, fig.width = 6.5, fig.height=5, fig.align="center"}
plot(sel.model, type = 4, k = 2, r = c(1,8,9))
```

If instead you want to display the expression of a single gene (e.g. `PCP4`) in the areas $r\in\{2,7\}$, run

```{r, eval = F, fig.width = 6.5, fig.height=5, fig.align="center"}
plot(sel.model, type = 4, gene.name = "PCP4", r = c(2,7))
```

### Visializing the highly variable genes in specific areas of the tissue




